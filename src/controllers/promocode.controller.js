const PromoCode = require("../models/promocode.model");
const { get_message } = require("../../utils/message");

exports.create = async (req, res) => {
    try {
        const { promoCode: code, discountType, discountAmount, conditions, minOrderValue } = req.body;

        if (!code) {
            return res.status(400).json({ status: false, message: get_message(1132) });
        }
        if (discountType === undefined) {
            return res.status(400).json({ status: false, message: get_message(1133) });
        }
        if (discountAmount === undefined) {
            return res.status(400).json({ status: false, message: get_message(1134) });
        }
        if (!conditions) {
            return res.status(400).json({ status: false, message: get_message(1135) });
        }
        const promoCode = new PromoCode();

        promoCode.promoCode = code;
        promoCode.discountType = parseInt(discountType, 10);
        promoCode.discountAmount = parseInt(discountAmount, 10);
        promoCode.minOrderValue = parseInt(minOrderValue, 10) || 0;

        // Handle both array and comma-separated string for conditions
        if (Array.isArray(conditions)) {
            promoCode.conditions = conditions;
        } else {
            promoCode.conditions = conditions.toString().split(",").map(c => c.trim()).filter(c => c);
        }

        await promoCode.save();

        return res.status(200).json({
            status: true,
            message: "PromoCode generated by admin.",
            promoCode,
        });
    } catch (error) {
        console.error(error);
        return res.status(500).json({
            status: false,
            error: error.message || "Internal Server error",
        });
    }
};

exports.update = async (req, res) => {
    try {
        const { promoCodeId } = req.query;
        if (!promoCodeId) {
            return res.status(400).json({ status: false, message: get_message(1136) });
        }

        const updateData = { ...req.body };

        if (updateData.discountType !== undefined) updateData.discountType = parseInt(updateData.discountType, 10);
        if (updateData.discountAmount !== undefined) updateData.discountAmount = parseInt(updateData.discountAmount, 10);
        if (updateData.minOrderValue !== undefined) updateData.minOrderValue = parseInt(updateData.minOrderValue, 10);

        if (updateData.conditions) {
            if (!Array.isArray(updateData.conditions)) {
                updateData.conditions = updateData.conditions.toString().split(",").map(c => c.trim()).filter(c => c);
            }
        }

        const promoCode = await PromoCode.findByIdAndUpdate(
            promoCodeId,
            { $set: updateData },
            { new: true }
        );

        if (!promoCode) {
            return res.status(404).json({ status: false, message: get_message(1137) });
        }

        return res.status(200).json({
            status: true,
            message: "promoCode updated by admin.",
            promoCode,
        });
    } catch (error) {
        console.error(error);
        return res.status(500).json({
            status: false,
            error: error.message || "Internal Server Error",
        });
    }
};

exports.delete = async (req, res) => {
    try {
        const { promoCodeId } = req.query;
        if (!promoCodeId) {
            return res.status(400).json({ status: false, message: get_message(1136) });
        }

        const promoCode = await PromoCode.findByIdAndUpdate(
            promoCodeId,
            { $set: { isDeleted: true } },
            { new: true }
        );

        if (!promoCode) {
            return res.status(404).json({ status: false, message: get_message(1137) });
        }

        return res.status(200).json({ status: true, message: "promoCode deleted by admin." });
    } catch (error) {
        console.error(error);
        return res.status(500).json({
            status: false,
            error: error.message || "Internal Server Error",
        });
    }
};

exports.getAll = async (req, res) => {
    try {
        const promoCode = await PromoCode.find({ isDeleted: { $ne: true } }).sort({ createdAt: -1 }).lean();

        return res.status(200).json({
            status: true,
            message: "get all promoCode Successfully.",
            promoCode: promoCode || [],
        });
    } catch (error) {
        console.error(error);
        return res.status(500).json({
            status: false,
            error: error.message || "Internal Server Error",
        });
    }
};
